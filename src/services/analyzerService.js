const llmService = require("./llmService");
const gitlabService = require("./gitlabService");
const confluenceService = require("./confluenceService");
const dbService = require("./dbService");
const logger = require("../utils/logger");

// Feature flag
const USE_LLM = process.env.USE_LLM === "true";

/**
 * Fallback (mock) flows when OpenAI is disabled
 */
function getMockFlows() {
  return [
    {
      name: "GitLab Webhook Receiver Flow",
      description: "Handles merge request webhook processing"
    }
  ];
}

/**
 * Fallback (mock) documentation when OpenAI is disabled
 */
function getMockDocumentation(flow, action) {
  return `
<h1>${flow.name}</h1>

<p><b>Action:</b> ${action.toUpperCase()}</p>

<h2>Overview</h2>
<p>
This documentation is auto-generated in fallback mode.
OpenAI integration is currently disabled.
</p>

<h2>Flow Description</h2>
<p>
${flow.description || "N/A"}
</p>

<h2>Notes</h2>
<ul>
  <li>Source: GitLab Merge Request</li>
  <li>Generated by ai-analyzer service</li>
</ul>
`;
}

exports.processMergeRequest = async (payload) => {
  logger.info(`üöÄ Processing MR ${payload.mr_id}`);

  // 1Ô∏è‚É£ Fetch GitLab code context
  const codeContext = await gitlabService.expandContext(payload);

  // 2Ô∏è‚É£ Identify flows
  let flows;
  if (USE_LLM) {
    logger.info("ü§ñ Identifying flows via OpenAI");
    flows = await llmService.identifyFlows(codeContext);
  } else {
    logger.warn("‚ö†Ô∏è OpenAI disabled. Using mock flows.");
    flows = getMockFlows();
  }

  // 3Ô∏è‚É£ Process each flow
  for (const flow of flows) {
    logger.info(`‚û°Ô∏è Processing flow: ${flow.name}`);

    // DB lookup
    const existingPage = await dbService.findFlow(flow.name);

    const action = existingPage ? "update" : "create";

    // 4Ô∏è‚É£ Generate documentation
    let documentation;
    if (USE_LLM) {
      logger.info(`‚úçÔ∏è Generating ${action} documentation using OpenAI`);
      documentation = await llmService.generateDocumentation({
        flow,
        context: codeContext,
        action
      });
    } else {
      logger.warn("‚ö†Ô∏è OpenAI disabled. Using mock documentation.");
      documentation = getMockDocumentation(flow, action);
    }

    // 5Ô∏è‚É£ Write to Confluence
    if (existingPage) {
      logger.info(`üìò Updating existing Confluence page for ${flow.name}`);
      await confluenceService.updatePage(
        existingPage.pageId,
        flow.name,
        documentation,
        existingPage.version
      );
    } else {
      logger.info(`üìÑ Creating new Confluence page for ${flow.name}`);
      const pageId = await confluenceService.createPage(
        flow.name,
        documentation
      );
      await dbService.saveFlow(flow.name, pageId);
    }

    logger.info(`‚úÖ Flow processed successfully: ${flow.name}`);
  }

  logger.info("üéâ Merge Request processing completed");
};
